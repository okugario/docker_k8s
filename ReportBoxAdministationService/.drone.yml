kind: pipeline
type: kubernetes
name: default

clone:
  disable: true

steps:
  - name: ssh and deploy
    image: appleboy/drone-ssh
    settings:
      host: 192.168.40.203
      username:
        from_secret: ssh_login
      password:
        from_secret: ssh_password
      port: 22
      command_timeout: 10m
      script:
        - echo =========Delete========
        - cd /opt/Projects
        - rm -r ReportBoxAdministartionService
        - rm -r GoWebStruct
        - echo =========Clone=======
        - pwd
        - cd /opt/Projects
        - git clone http://192.168.7.70:31644/okugario/ReportBoxAdministartionService.git
        - git clone http://192.168.7.70:31644/okugario/GoWebStruct.git
        - echo =========Build=========
        - cd /opt/Projects/ReportBoxAdministartionService
        - docker build -t okugario/rbadministartionservice:dev .
        - echo =========Run==========
        - docker login
        - echo "$docker_password" | docker login -u "$docker_username" --password-stdin
        - docker push okugario/rbadministartionservice:dev
        - echo ========DeleteKube====
        - kubectl delete service administartionservice
        - kubectl delete deployment administartionservice
        - echo =========Done=========
        - cd /opt/Projects/ReportBoxAdministartionService
        - kubectl apply -f deployment.yaml
        - kubectl apply -f service.yaml

trigger:
  branch:
    - main
  event:
    - push
